#!/usr/bin/env bash
#
# AgentOS - Self-hosted AI coding session manager
# https://github.com/anthropics/agent-os
#

set -euo pipefail

# Configuration
AGENT_OS_HOME="${AGENT_OS_HOME:-$HOME/.agent-os}"
PORT="${AGENT_OS_PORT:-3011}"
REPO_URL="https://github.com/elabx-org/agent-os.git"

# Derived paths
REPO_DIR="$AGENT_OS_HOME/repo"
PID_FILE="$AGENT_OS_HOME/agent-os.pid"
LOG_FILE="$AGENT_OS_HOME/agent-os.log"

# Detect OS
OS=$(uname -s | tr '[:upper:]' '[:lower:]')
[[ "$OS" == "darwin" ]] && OS="macos"

# Source Homebrew if available (ensures npm/node/etc are in PATH)
if [[ "$OS" == "macos" ]]; then
    if [[ -f /opt/homebrew/bin/brew ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    elif [[ -f /usr/local/bin/brew ]]; then
        eval "$(/usr/local/bin/brew shellenv)"
    fi
fi

# Source fnm if available (for non-admin users who installed via fnm)
if [[ -d "$HOME/.local/share/fnm" ]]; then
    export PATH="$HOME/.local/share/fnm:$PATH"
    eval "$(fnm env --use-on-cd 2>/dev/null || true)"
fi

# Add ~/.local/bin to PATH (for ripgrep and other binaries installed for non-admin users)
if [[ -d "$HOME/.local/bin" ]]; then
    export PATH="$HOME/.local/bin:$PATH"
fi

# Styling
BOLD='\033[1m'
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Find script directory (works even when called via symlink)
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [[ -L "$SCRIPT_PATH" ]]; do
    SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT_PATH")" && pwd)"

# Local repo path (parent of scripts dir) - used for --local installs
LOCAL_REPO="$(dirname "$SCRIPT_DIR")"

# Source library files
source "$SCRIPT_DIR/lib/common.sh"
source "$SCRIPT_DIR/lib/prerequisites.sh"
source "$SCRIPT_DIR/lib/ai-clis.sh"
source "$SCRIPT_DIR/lib/commands.sh"

# Main
case "${1:-}" in
    install)          cmd_install "${2:-}" ;;
    start)            cmd_start ;;
    stop)             cmd_stop ;;
    restart)          cmd_restart ;;
    run)              cmd_run ;;
    status)           cmd_status ;;
    logs)             cmd_logs ;;
    update)           cmd_update ;;
    deploy)           cmd_deploy "${2:-}" ;;
    enable)           cmd_enable ;;
    disable)          cmd_disable ;;
    uninstall)        cmd_uninstall ;;
    start-foreground) cmd_start_foreground ;;
    help|--help|-h)   cmd_help ;;
    *)
        if [[ -n "${1:-}" ]]; then
            log_error "Unknown command: $1"
        fi
        cmd_help
        exit 1
        ;;
esac
